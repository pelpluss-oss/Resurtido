<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Indicador Ubicaciones Restringidas PRO</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- XLSX -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Remix Icons for illustrations -->
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
  <style>
    :root {
      --color-primary: #0050b8;
      --color-secondary: #21b573;
      --color-bg: linear-gradient(120deg, #eaf6ff 0%, #c7ebfc 100%);
      --color-card: #fff;
      --color-accent: #fdb813;
      --color-danger: #f14c4c;
      --color-box-shadow: 0 8px 36px rgba(30,36,64,0.10);
      --radius: 18px;
      --font-main: 'Inter', 'Segoe UI', Arial, sans-serif;
    }
    body {
      font-family: var(--font-main);
      min-height: 100vh;
      margin: 0;
      padding: 0;
      background: var(--color-bg);
      color: #232a33;
      box-sizing: border-box;
    }
    header {
      background: #fff;
      box-shadow: var(--color-box-shadow);
      border-bottom-left-radius: var(--radius);
      border-bottom-right-radius: var(--radius);
      padding: 28px 0 16px;
      text-align: center;
      margin-bottom: 16px;
    }
    header h1 {
      font-size: 2.2em;
      color: var(--color-primary);
      margin: 0 0 4px 0;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      letter-spacing: -0.8px;
    }
    header h1 i {
      color: var(--color-accent);
      font-size: 1.2em;
    }
    .subtitle {
      color: #6b7686;
      font-size: 1.09em;
      margin-bottom: 0;
    }
    .button-group {
      display: flex;
      gap: 18px;
      justify-content: center;
      margin: 22px 0 12px 0;
      flex-wrap: wrap;
    }
    .button {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 13px 26px;
      font-size: 1.08em;
      font-weight: 600;
      border-radius: 14px;
      border: none;
      color: #fff;
      background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
      box-shadow: var(--color-box-shadow);
      cursor: pointer;
      transition: background 0.18s, box-shadow 0.18s, transform 0.13s;
      outline: none;
      text-decoration: none;
    }
    .button[role="file"] {
      background: linear-gradient(90deg, #06b6d4 35%, var(--color-secondary));
    }
    .button[role="file"]:hover, .button:hover, .button:focus-visible {
      background: linear-gradient(90deg, var(--color-secondary), var(--color-primary));
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 10px 32px #0050b82a;
    }
    .button:active {
      transform: scale(0.97);
    }
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: auto auto;
      gap: 22px;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 16px 26px 16px;
    }
    .box {
      background: var(--color-card);
      border-radius: var(--radius);
      box-shadow: var(--color-box-shadow);
      padding: 20px 18px 16px 18px;
      min-height: 210px;
      overflow: auto;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    .box h3 {
      margin: 0 0 10px 0;
      color: var(--color-primary);
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1.12em;
      font-weight: 700;
    }
    .ilustracion {
      display: flex;
      justify-content: flex-end;
      opacity: 0.18;
      font-size: 3.5em;
      position: absolute;
      right: 14px;
      top: 18px;
      pointer-events: none;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.92em;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #e6eef8;
      padding: 7px 9px;
      text-align: center;
      background: #fff;
    }
    th {
      background: var(--color-primary);
      color: #fff;
      font-weight: 700;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tr:hover { background: #f1f9ff !important; cursor: pointer; }
    .alerta { background: #ffe9e9 !important; color: var(--color-danger); font-weight: 600; }
    canvas { width: 100% !important; height: 312px !important; margin: 0 auto; }
    #backBtn {
      margin: 10px 0 0 0;
      padding: 8px 12px;
      background: var(--color-secondary);
      color: #fff;
      border: none;
      border-radius: 7px;
      cursor: pointer;
      display: none;
      font-size: 1em;
      transition: background 0.18s;
    }
    #backBtn:hover { background: var(--color-primary); }

    /* IA Panel */
    .box-ia {
      grid-column: span 2;
      background: linear-gradient(98deg, #eafaf6 0%, #e6eeff 100%);
      border-radius: var(--radius);
      box-shadow: 0 4px 16px #0050b81d;
      margin-top: 6px;
      padding: 18px 14px;
    }
    .box-ia h3 {
      color: var(--color-secondary);
      font-size: 1.06em;
      margin-bottom: 7px;
      display: flex;
      align-items: center;
      gap: 7px;
    }
    #resumenIA {
      font-size: 1.04em;
      line-height: 1.55;
      color: #232a33;
      min-height: 32px;
    }
    @media (max-width: 900px) {
      .main-grid { grid-template-columns: 1fr; grid-template-rows: auto auto auto auto; }
      .box-ia { grid-column: span 1; }
    }
    @media (max-width: 600px) {
      header h1 { font-size: 1.1em; }
      .main-grid { padding: 0 3vw 16px 3vw; gap:10px;}
      .box { padding: 10px 2vw 10px 2vw; min-height: 150px;}
      table, th, td { font-size: 0.85em; }
      .ilustracion { font-size: 2.3em; top:10px; right: 5px;}
      .box-ia { padding: 11px 2vw; }
    }
  </style>
</head>
<body>
<header>
  <h1><i class="ri-lock-2-line"></i> Indicador Ubicaciones Restringidas PRO</h1>
  <div class="subtitle">Panel avanzado de an√°lisis y visualizaci√≥n</div>
</header>

<div class="button-group">
  <a href="index.html" class="button"><i class="ri-home-3-line"></i> Inicio</a>
  <label class="button" role="file" for="fileInput"><i class="ri-upload-cloud-2-line"></i> Elegir Archivo</label>
  <button class="button" id="btnIA"><i class="ri-robot-2-line"></i> Informe con IA</button>
</div>
<input id="fileInput" type="file" accept=".xlsx,.xls" style="display:none;" />

<div class="main-grid">
  <div class="box" id="boxUbicaciones">
    <div class="ilustracion"><i class="ri-map-pin-2-line"></i></div>
    <h3><i class="ri-database-2-line"></i> Ubicaciones (F) ‚Äî totales por O y $S</h3>
    <table id="tablaUbicaciones">
      <thead>
        <tr><th>Ubicaci√≥n</th><th>Total Cantidad (O)</th><th>Total Valor ($S)</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="box" id="boxGrafico">
    <div class="ilustracion"><i class="ri-bar-chart-grouped-line"></i></div>
    <h3><i class="ri-bar-chart-2-line"></i> Gr√°fico</h3>
    <canvas id="chartUbicaciones"></canvas>
    <button id="backBtn">üîô Volver a gr√°fico de ubicaciones</button>
  </div>
  <div class="box" id="boxProductos">
    <div class="ilustracion"><i class="ri-box-3-line"></i></div>
    <h3><i class="ri-price-tag-3-line"></i> Productos (click en ubicaci√≥n)</h3>
    <table id="tablaProductos">
      <thead>
        <tr>
          <th>Nombre (M)</th>
          <th>C√≥digo (L)</th>
          <th>Cantidad (O)</th>
          <th>Valor ($S)</th>
          <th>D√≠as (Hoy - X)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="box" id="boxProceso">
    <div class="ilustracion"><i class="ri-information-line"></i></div>
    <h3><i class="ri-information-line"></i> Informaci√≥n de Ubicaciones</h3>
    <p id="infoUbicaciones">Por favor, carga un archivo para ver el resumen de ubicaciones.</p>
    <div id="logProceso"></div>
  </div>
  <div class="box-ia">
    <h3><i class="ri-robot-line"></i> Informe Detallado por Inteligencia Artificial</h3>
    <div id="resumenIA">Carga un archivo y presiona el bot√≥n <b>Informe con IA</b> para obtener un an√°lisis global profesional con IA.</div>
  </div>
</div>

<script>
let datosRows = [];
let ubicaciones = {};
let productosPorUb = {};
let chart = null;
let ubicacionSeleccionada = null;

function excelSerialToJSDate(serial) {
  const utc_days = Math.floor(serial - 25569);
  const utc_value = utc_days * 86400;
  const date_info = new Date(utc_value * 1000);
  const fractional = serial - Math.floor(serial);
  const seconds = Math.round(fractional * 86400);
  date_info.setSeconds(date_info.getSeconds() + seconds);
  return date_info;
}
function parseCellAsDate(v) {
  if (!v) return null;
  if (v instanceof Date) return isNaN(v.getTime()) ? null : v;
  if (typeof v === "number") return excelSerialToJSDate(v);
  const t = Date.parse(v);
  return isNaN(t) ? null : new Date(t);
}

document.getElementById('fileInput').addEventListener('change', (ev) => {
  const f = ev.target.files[0];
  if (!f) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data, { type: 'array' });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    datosRows = XLSX.utils.sheet_to_json(sheet, { header:1, raw:true, defval: "" });
    procesarRows(datosRows);
    log("‚úÖ Archivo cargado: " + f.name);
    document.getElementById("resumenIA").innerHTML = "Carga un archivo y presiona el bot√≥n <b>Informe con IA</b> para obtener un an√°lisis global profesional con IA.";
  };
  reader.readAsArrayBuffer(f);
});

function procesarRows(rows) {
  ubicaciones = {};
  productosPorUb = {};
  ubicacionSeleccionada = null;
  const valid = ["RESTR","TRASL","NOVED","CENEX","FALTA","CONSU"];
  const hoy = new Date();

  for (let i=1; i<rows.length; i++) {
    const r = rows[i];
    if (!r) continue;
    const ubic = String(r[5]||"").trim();
    if (!valid.includes(ubic)) continue;

    const articulo = String(r[11]||"");
    const nombre = String(r[12]||"");
    const cantidad = Number(r[14])||0;
    const valor = Number(r[18])||0;
    const fecha = parseCellAsDate(r[23]);
    const dias = fecha ? Math.floor((hoy - fecha)/(1000*60*60*24)) : null;

    if (!ubicaciones[ubic]) ubicaciones[ubic] = { cantidad:0, valor:0 };
    ubicaciones[ubic].cantidad += cantidad;
    ubicaciones[ubic].valor += valor;

    if (!productosPorUb[ubic]) productosPorUb[ubic] = [];
    productosPorUb[ubic].push({ articulo, nombre, cantidad, valor, dias });
  }

  renderUbicacionesTable();
  drawUbicacionesChart();
  actualizarInfoUbicaciones();
  document.querySelector('#tablaProductos tbody').innerHTML = "";
}

function actualizarInfoUbicaciones() {
  const totalUb = Object.keys(ubicaciones).length;
  let totalCant = 0, totalVal = 0;
  for (const ub in ubicaciones) {
    totalCant += ubicaciones[ub].cantidad;
    totalVal += ubicaciones[ub].valor;
  }
  ubicacionSeleccionada = null;
  document.getElementById("infoUbicaciones").innerHTML =
    `üìå Se encontraron <b>${totalUb}</b> ubicaciones v√°lidas.<br>
     üì¶ Total de productos: <b>${totalCant}</b><br>
     üí∞ Valor total: <b>$${totalVal.toLocaleString()}</b>`;
}

function actualizarInfoUbicacion(ubic) {
  const datos = productosPorUb[ubic] || [];
  let totalCant = 0, totalVal = 0;
  let diasMax = null, diasMin = null;

  datos.forEach(p => {
    totalCant += p.cantidad;
    totalVal += p.valor;
    if (p.dias !== null) {
      if (diasMax === null || p.dias > diasMax) diasMax = p.dias;
      if (diasMin === null || p.dias < diasMin) diasMin = p.dias;
    }
  });

  ubicacionSeleccionada = ubic;

  let html = `
    üìå Ubicaci√≥n: <b>${ubic}</b><br>
    üì¶ Total de productos: <b>${totalCant}</b><br>
    üí∞ Valor total: <b>$${totalVal.toLocaleString()}</b><br>
  `;
  if (diasMin !== null) {
    html += `üìÖ D√≠as m√°s viejo: <b>${diasMax}</b>, d√≠as menos viejo: <b>${diasMin}</b><br>`;
  }
  html += `üßÆ Cantidad de productos distintos: <b>${datos.length}</b>`;

  document.getElementById("infoUbicaciones").innerHTML = html;
}

function renderUbicacionesTable() {
  const tbody = document.querySelector('#tablaUbicaciones tbody');
  tbody.innerHTML = "";
  Object.keys(ubicaciones).forEach(ub => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${ub}</td>
                    <td>${ubicaciones[ub].cantidad}</td>
                    <td>$${ubicaciones[ub].valor.toLocaleString()}</td>`;
    tr.addEventListener('click', () => {
      mostrarProductos(ub);
      drawProductosChart(ub);
      actualizarInfoUbicacion(ub);
      document.getElementById('backBtn').style.display = 'inline-block';
    });
    tbody.appendChild(tr);
  });
}

function drawUbicacionesChart() {
  const ctx = document.getElementById('chartUbicaciones').getContext('2d');
  if (chart) chart.destroy();
  const labels = Object.keys(ubicaciones);
  const data = labels.map(l => ubicaciones[l].cantidad);
  const colors = labels.map((_,i)=>getColor(i));
  chart = new Chart(ctx, {
    type:'bar',
    data:{ labels, datasets:[{ label:'Cantidad', data, backgroundColor:colors }] },
    options:{ responsive:true }
  });
  document.getElementById('backBtn').style.display='none';
}

function drawProductosChart(ubicacion) {
  const productos = productosPorUb[ubicacion]||[];
  const ctx = document.getElementById('chartUbicaciones').getContext('2d');
  if (chart) chart.destroy();
  const labels = productos.map(p=>p.nombre||p.articulo);
  const data = productos.map(p=>p.cantidad);
  const colors = labels.map((_,i)=>getColor(i));
  chart = new Chart(ctx, {
    type:'bar',
    data:{ labels, datasets:[{ label:`Cantidades en ${ubicacion}`, data, backgroundColor:colors }] },
    options:{ responsive:true }
  });
}

function mostrarProductos(ubicacion) {
  const tbody = document.querySelector('#tablaProductos tbody');
  tbody.innerHTML="";
  const datos = productosPorUb[ubicacion] || [];
  datos.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${escapeHtml(p.nombre)}</td>
                  <td>${escapeHtml(p.articulo)}</td>
                  <td>${p.cantidad}</td>
                  <td>$${p.valor.toLocaleString()}</td>
                  <td>${p.dias!==null?p.dias:""}</td>`;
    if(p.dias>30) tr.classList.add('alerta');
    tbody.appendChild(tr);
  });
}

function getColor(i){ const c=['#3b82f6','#06b6d4','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899','#475569']; return c[i%c.length]; }
function escapeHtml(s){ return String(s||"").replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
function log(msg){ const el=document.getElementById('logProceso'); if(!el)return; const p=document.createElement('div'); p.textContent=msg; el.prepend(p); }

document.getElementById('backBtn').addEventListener('click', ()=>{
  drawUbicacionesChart();
  actualizarInfoUbicaciones();
  document.querySelector('#tablaProductos tbody').innerHTML = "";
  document.getElementById('backBtn').style.display = 'none';
});

// ====== IA Panel ======
document.getElementById("btnIA").addEventListener("click", generarInformeIA);

async function generarInformeIA() {
  const resumenDiv = document.getElementById("resumenIA");
  if (Object.keys(ubicaciones).length === 0) {
    resumenDiv.innerHTML = "<span style='color:#b50000'>No hay datos para analizar.</span>";
    return;
  }
  resumenDiv.innerHTML = "<i>Procesando an√°lisis con IA...</i>";

  // Prepara un resumen compacto de ubicaciones y productos (solo las primeras 5 ubicaciones y 10 productos por ubicaci√≥n para la IA)
  let resumenData = "";
  let ubicKeys = Object.keys(ubicaciones).slice(0, 5);
  for (let ub of ubicKeys) {
    resumenData += `Ubicaci√≥n: ${ub}, Cantidad total: ${ubicaciones[ub].cantidad}, Valor total: ${ubicaciones[ub].valor}\n`;
    let productos = (productosPorUb[ub] || []).slice(0, 10);
    for (let p of productos) {
      resumenData += `  - Producto: ${p.nombre}, C√≥digo: ${p.articulo}, Cantidad: ${p.cantidad}, Valor: ${p.valor}, D√≠as: ${p.dias}\n`;
    }
    if ((productosPorUb[ub] || []).length > 10) resumenData += "  ...\n";
  }
  if (Object.keys(ubicaciones).length > 5) resumenData += "... (solo primeras ubicaciones mostradas)\n";

  // PROMPT en espa√±ol para OpenAI o similar
  const prompt = `
Analiza los siguientes datos de ubicaciones restringidas en un inventario empresarial. Comenta sobre tendencias, anomal√≠as, recomendaciones y posibles riesgos. Explica qu√© ubicaciones o productos requieren atenci√≥n prioritaria, y da sugerencias para el equipo. Usa un lenguaje profesional, claro y conciso. Los datos son:
${resumenData}
`;

  // === LLAMADA IA: REEMPLAZA TU API KEY ABAJO ===
  const OPENAI_API_KEY = "TU_API_KEY_AQUI"; // Cambia esto por tu propia API key

  try {
    const resp = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + OPENAI_API_KEY
      },
      body: JSON.stringify({
        model: "gpt-3.5-turbo",
        messages: [{role: "user", content: prompt}],
        max_tokens: 380,
        temperature: 0.6
      })
    });
    const data = await resp.json();
    const resumen = data.choices?.[0]?.message?.content || "No se pudo generar el informe.";
    resumenDiv.innerHTML = `<b>Informe IA:</b><br><p>${resumen}</p>`;
  } catch (err) {
    resumenDiv.innerHTML = "<span style='color:#b50000'>Error al conectar con la IA. Revisa la consola (F12).</span>";
    console.error("Error IA:", err);
  }
}
</script>
</body>
</html>